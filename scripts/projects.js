// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ):
// assets/images/projects/
// ‚îú‚îÄ portfolio/portfolio-1.png, portfolio-1-150.png, portfolio-1-300.png, portfolio-1.avif, portfolio-1.webp
// ‚îÇ              portfolio-2.png, portfolio-2-150.png, portfolio-2-300.png, portfolio-2.avif, portfolio-2.webp
// ‚îú‚îÄ library/library-1.png, library-1-150.png, library-1-300.png, library-1.avif, library-1.webp
// ‚îÇ          library-2.png, library-2-150.png, library-2-300.png, library-2.avif, library-2.webp
// ‚îú‚îÄ goods/goods-1.png, goods-1-150.png, goods-1-300.png, goods-1.avif, goods-1.webp
// ‚îî‚îÄ chess/chess-1.png, chess-1-150.png, chess-1-300.png, chess-1.avif, chess-1.webp
//             chess-2.png, chess-2-150.png, chess-2-300.png, chess-2.avif, chess-2.webp

const projectsData = {
  1: {
    title: "–õ–∏—á–Ω—ã–π —Å–∞–π—Ç + –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ",
    description:
      "–û–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç‚Äë–≤–∏–∑–∏—Ç–∫–∞ —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ. –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –≤–µ—Ä—Å—Ç–∫—É, —Å–µ–º–∞–Ω—Ç–∏–∫—É, –∞–¥–∞–ø—Ç–∏–≤ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.",
    technologies: ["HTML5", "CSS3", "Bootstrap"],
    liveLink: "https://creature100.github.io/frontend-and-backend-practice/index.html",
    githubLink: "https://github.com/CreaTure100/frontend-and-backend-practice",
    screenshots: [
      "../assets/images/projects/portfolio/portfolio-1.png",
      "../assets/images/projects/portfolio/portfolio-2.png",
    ],
  },
  2: {
    title: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ‚Äë–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (Python + SQL)",
    description:
      "–î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞ Python —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (SQL): —É—á–µ—Ç –∫–Ω–∏–≥, —á–∏—Ç–∞—Ç–µ–ª–µ–π, –≤—ã–¥–∞—á.",
    technologies: ["Python", "SQL"],
    liveLink: "https://github.com/CreaTure100/BD_biblioteka_02",
    githubLink: "https://github.com/CreaTure100/BD_biblioteka_02",
    screenshots: [
      "../assets/images/projects/library/library-1.png",
      "../assets/images/projects/library/library-2.png",
    ],
  },
  3: {
    title: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç‚Äë–º–∞–≥–∞–∑–∏–Ω (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤)",
    description:
      "–î–µ–º–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤: –∫–∞—Ä—Ç–æ—á–∫–∏, —Ñ–∏–ª—å—Ç—Ä—ã, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤. –§–æ–∫—É—Å –Ω–∞ —Ä–∞–±–æ—Ç—É —Å DOM –∏ —Å–æ–±—ã—Ç–∏—è–º–∏.",
    technologies: ["JavaScript"],
    liveLink: "https://creature100.github.io/frontend-and-backend-practice/pages/goods.html",
    githubLink: "https://github.com/CreaTure100/frontend-and-backend-practice",
    screenshots: ["../assets/images/projects/goods/goods-1.png"],
  },
  4: {
    title: "–®–∞—Ö–º–∞—Ç—ã (C++ –∫—É—Ä—Å–æ–≤–∞—è)",
    description:
      "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ¬´–®–∞—Ö–º–∞—Ç—ã¬ª –Ω–∞ C++ —Å –ª–æ–≥–∏–∫–æ–π –∏–≥—Ä—ã –∏ –ò–ò –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã.",
    technologies: ["C++"],
    liveLink: "https://github.com/CreaTure100/Chess",
    githubLink: "https://github.com/CreaTure100/Chess",
    screenshots: [
      "../assets/images/projects/chess/chess-1.png",
      "../assets/images/projects/chess/chess-2.png",
    ],
  },
};

let lastFocusedElement = null;

document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("projectModal");
  const closeBtn = document.querySelector(".close-modal");
  const modalBody = document.querySelector(".modal-body");
  const projectCards = document.querySelectorAll(".project-card-large, .project-card");
  const filterBtns = document.querySelectorAll(".filter-btn, .filters .chip");

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  projectCards.forEach((card) => {
    card.addEventListener("click", () => {
      const projectId = card.getAttribute("data-project");
      openModal(projectId || inferIdByTitle(card));
    });
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const projectId = card.getAttribute("data-project");
        openModal(projectId || inferIdByTitle(card));
      }
    });
  });

  // –§–∏–ª—å—Ç—Ä—ã
  filterBtns.forEach((btn) => {
    btn.addEventListener("click", function () {
      const filter = this.getAttribute("data-filter");
      filterBtns.forEach((b) => {
        b.classList.remove("active", "is-active");
        b.setAttribute("aria-selected", "false");
      });
      this.classList.add("active", "is-active");
      this.setAttribute("aria-selected", "true");
      filterProjects(filter);
    });
  });

  function filterProjects(filter) {
    document.querySelectorAll(".project-card-large, .project-card").forEach((card) => {
      const cat = card.getAttribute("data-category");
      card.style.display = filter === "all" || cat === filter ? "" : "none";
    });
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  closeBtn?.addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });
  modal?.addEventListener("click", (e) => {
    if (e.target.classList.contains("modal__backdrop")) closeModal();
  });

  function inferIdByTitle(card) {
    const title = card.querySelector(".project-card__title")?.textContent.trim() || "";
    if (title.includes("–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ")) return "1";
    if (title.includes("–±–∏–±–ª–∏–æ—Ç–µ–∫–∞")) return "2";
    if (title.includes("–ò–Ω—Ç–µ—Ä–Ω–µ—Ç")) return "3";
    if (title.includes("–®–∞—Ö–º–∞—Ç—ã")) return "4";
    return null;
  }

  function buildScreenshotItem(screenshot, index, title) {
    const stem = screenshot.replace(/\.(png|jpg|jpeg|webp|avif)$/i, "");
    const avif150 = `${stem}-150.avif`;
    const avif300 = `${stem}-300.avif`;
    const webp150 = `${stem}-150.webp`;
    const webp300 = `${stem}-300.webp`;
    const png150 = `${stem}-150.png`;
    const png300 = `${stem}-300.png`;

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—É—Ç–µ–π
    console.debug("Screenshot stem:", stem, {
      avif150, avif300, webp150, webp300, png150, png300, raw: screenshot,
    });

    return `
      <div class="screenshot-item">
        <picture>
          <source type="image/avif"
                  srcset="${avif150} 150w, ${avif300} 300w"
                  sizes="(max-width: 640px) 100vw, 320px">
          <source type="image/webp"
                  srcset="${webp150} 150w, ${webp300} 300w"
                  sizes="(max-width: 640px) 100vw, 320px">
          <img class="project-screenshot"
               src="${png300}"
               srcset="${png150} 150w, ${png300} 300w"
               sizes="(max-width: 640px) 100vw, 320px"
               width="320" height="180"
               alt="–°–∫—Ä–∏–Ω—à–æ—Ç ¬´${title}¬ª ${index + 1}"
               loading="lazy" decoding="async"
               onerror="console.warn('Image 404, fallback raw:', this.src, '‚Üí', '${screenshot}'); this.onerror=null; this.src='${screenshot}'; this.removeAttribute('srcset'); this.removeAttribute('sizes');">
        </picture>
      </div>`;
  }

  function openModal(projectId) {
    lastFocusedElement = document.activeElement;

    const project = projectsData[projectId];
    if (!project) return;

    // ARIA
    modal.setAttribute("aria-modal", "true");
    modal.setAttribute("role", "dialog");
    modal.setAttribute("aria-labelledby", "modal-title");

    // –°–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç —Å–∫—Ä–∏–Ω—Ä–∏–¥–µ—Ä–∞
    document
      .querySelectorAll("body > *:not(.modal)")
      .forEach((el) => el.setAttribute("aria-hidden", "true"));

    // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
    const techHtml = (project.technologies || [])
      .map((tech) => `<span class="tech-tag">${tech}</span>`)
      .join("");

    // –ì–∞–ª–µ—Ä–µ—è
    const screenshotsHtml =
      (project.screenshots || []).length > 0
        ? project.screenshots.map((s, i) => buildScreenshotItem(s, i, project.title)).join("")
        : `<div class="screenshot-item screenshot-placeholder">
             <div class="screenshot-content">
               <p>–°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
               <div class="placeholder-icon">üì∑</div>
             </div>
           </div>`;

    // –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏
    const linksHtml = `
      <div class="modal__actions project-links">
        <a href="${project.liveLink}" target="_blank" rel="noopener" class="btn btn--ghost button project-link">–î–µ–º–æ</a>
        <a href="${project.githubLink}" target="_blank" rel="noopener" class="btn button project-link github">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</a>
      </div>`;

    modalBody.innerHTML = `
      <h2 id="modal-title">${project.title}</h2>
      <p class="project-description">${project.description}</p>
      <div class="project-tech">${techHtml}</div>
      <h3>–°–∫—Ä–∏–Ω—à–æ—Ç—ã</h3>
      <div class="project-gallery modal__gallery">
        ${screenshotsHtml}
      </div>
      ${linksHtml}
    `;

    // –ü–æ–∫–∞–∑
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    modal.querySelector(".close-modal")?.focus();
  }

  function closeModal() {
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "auto";
    document
      .querySelectorAll("body > *:not(.modal)")
      .forEach((el) => el.removeAttribute("aria-hidden"));
    lastFocusedElement?.focus();
  }
});